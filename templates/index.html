<!DOCTYPE html>
<html>
<head>
    <title>komootRoutes - Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin=""/> <!-- Leaflet -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-sidebar-v2@3.2.3/css/leaflet-sidebar.min.css"> <!-- Leaflet-Sidebar -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css"> <!-- Font-Awesome -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/legend.css') }}"> <!-- Legend -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/button_group.css') }}"> <!-- Button Group -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}"> <!-- Custom -->

    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script> <!-- Leaflet -->
    <script src="https://cdn.jsdelivr.net/npm/gpxparser@3.0.8/dist/GPXParser.min.js"></script> <!-- GPX Parser -->
    <script src="https://hgoebl.github.io/Leaflet.MultiOptionsPolyline/Leaflet.MultiOptionsPolyline.js"></script> <!-- Leaflet-Polyline -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet-sidebar-v2@3.2.3/js/leaflet-sidebar.min.js"></script> <!-- Leaflet-Sidebar -->
</head>
<body>
    <div id="sidebar" class="leaflet-sidebar collapsed">
        <!-- Nav tabs -->
        <div class="leaflet-sidebar-tabs">
            <ul role="tablist"> <!-- top aligned tabs -->
                <li><a href="#home" role="tab"><i class="fa fa-bars"></i></a></li>
                <li><a href="#profile" role="tab"><i class="fa fa-user"></i></a></li>
            </ul>
        </div>
    
        <!-- Tab panes -->
        <div class="leaflet-sidebar-content">
            <div class="leaflet-sidebar-pane" id="home">
                <h1 class="leaflet-sidebar-header">
                    Komoot - Personal Heatmap
                    <div class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></div>
                </h1>
                <p>Mapping <b>32</b> of Oskar's bicycle rides.</p>

                <hr>

                <h3 class='custom-title'>Visualisation</h3>
                <div class="btn-group">
                    <button id="heatmap" onclick="Visualizer.show_polylines(map, allRoutes, 'heatmap');">Heatmap</button>
                    <button id="speed" onclick="Visualizer.show_polylines(map, allRoutes, 'speed');">Speed</button>
                    <button id="incline" onclick="Visualizer.show_polylines(map, allRoutes, 'incline');">Incline</button>
                    <button id="elapsed" onclick="Visualizer.show_polylines(map, allRoutes, 'elapsed');">Elapsed Time</button>
                </div>

                <hr>

                <div class='my-legend'>
                    <h3 class='custom-title'>Legend</h3>
                    <div class='legend-scale'>
                      <ul class='legend-labels'>
                        <li><span style='background:#0000FF;' id="lgd0"></span>0 - 20%</li>
                        <li><span style='background:#0040FF;' id="lgd1"></span>40%</li>
                        <li><span style='background:#0080FF;' id="lgd2"></span>60%</li>
                        <li><span style='background:#00FFB0;' id="lgd3"></span>80%</li>
                        <li><span style='background:#00E000;' id="lgd4"></span>100%</li>
                        <li><span style='background:#80FF00;' id="lgd5"></span>100%</li>
                        <li><span style='background:#FFFF00;' id="lgd6"></span>100%</li>
                        <li><span style='background:#FFC000;' id="lgd7"></span>100%</li>
                        <li><span style='background:#FF0000;' id="lgd8"></span>100%</li>
                      </ul>
                    </div>
                </div>
            </div>
    
            <div class="leaflet-sidebar-pane" id="profile">
                <h1 class="leaflet-sidebar-header">Profile<div class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></div></h1>
            </div>
        </div>
    </div>

    <div id="map" style="height: 100vh;"></div>

    <script>
        class Visualizer {
            static options = {
                    "heatmap": {
                        optionIdxFn: function(latLng, prevLatLng) {
                            return 0;
                        },
                        options: [
                            {color: '#FF0000'}
                        ]
                    },
                    "speed": {
                        optionIdxFn: function(latLng, prevLatLng) {
                            var i, speed,
                                speedThresholds = equalDistribution(0, speedMax, 9);

                            speed = getSpeed(latLng, prevLatLng);

                            for (i = 0; i < speedThresholds.length; ++i) {
                                if (speed <= speedThresholds[i]) {
                                    return i;
                                }
                            }
                            return speedThresholds.length;
                        },
                        options: [
                            {color: '#0000FF'}, {color: '#0040FF'}, {color: '#0080FF'},
                            {color: '#00FFB0'}, {color: '#00E000'}, {color: '#80FF00'},
                            {color: '#FFFF00'}, {color: '#FFC000'}, {color: '#FF0000'}
                        ]
                    },

                    "incline": {
                        optionIdxFn: function(latLng, prevLatLng) {
                            var i, incline,
                                inclineThresholds = [0, 2, 4, 6, 8, 10, 12, 14, 16];

                            incline = (latLng.alt - prevLatLng.alt) / latLng.distanceTo(prevLatLng) * 100;
                            incline = Math.abs(incline);

                            for (i = 0; i < inclineThresholds.length; ++i) {
                                if (incline <= inclineThresholds[i]) {
                                    return i;
                                }
                            }
                            return inclineThresholds.length;
                        },
                        options: [
                            {color: '#0000FF'}, {color: '#0040FF'}, {color: '#0080FF'},
                            {color: '#00FFB0'}, {color: '#00E000'}, {color: '#80FF00'},
                            {color: '#FFFF00'}, {color: '#FFC000'}, {color: '#FF0000'}
                        ]
                    },

                    "elapsed": {
                        optionIdxFn: function(latLng, prevLatLng, index, points) {
                            var i, time,
                                timeThresholds = equalDistribution(0, elapsedMax, 9);

                            time = (latLng.time - points[0].time) / 1000; 

                            for (i = 0; i < timeThresholds.length; ++i) {
                                if (time <= timeThresholds[i]) {
                                    return i;
                                }
                            }
                            return timeThresholds.length - 1;
                        },
                        options: [
                            {color: '#0000FF'}, {color: '#0040FF'}, {color: '#0080FF'},
                            {color: '#00FFB0'}, {color: '#00E000'}, {color: '#80FF00'},
                            {color: '#FFFF00'}, {color: '#FFC000'}, {color: '#FF0000'}
                        ]
                    }
            }

            static show_polylines(map, allRoutes, new_vizualisation) {
                //update buttons
                var buttons = document.getElementsByClassName("btn-group")[0].children;
                for (var i = 0; i < buttons.length; i++) {
                    if(buttons[i].id == new_vizualisation)
                        buttons[i].disabled = true;
                    else
                        buttons[i].disabled = false;
                }

                //remove all polylines
                for (var i = 0; i < polylines.length; i++) {
                    polylines[i].remove(map);
                }

                polylines = [];

                //create polylines
                let opacity = 0.75;

                if(new_vizualisation == "heatmap") {
                    opacity = 0.5;
                }

                for (var i = 0; i < tours.length; i++) {
                    //create multi options polyline
                    var polyline = L.multiOptionsPolyline(allRoutes[i], {
                        multiOptions: Visualizer.options[new_vizualisation],
                        weight: 4,
                        lineCap: 'round',
                        opacity: opacity,
                        smoothFactor: 1}
                    ).addTo(map);

                    //add polyline to array
                    polylines.push(polyline);
                }
            }
        }

        //Calculates the speed between two latLngs
        function getSpeed(latLng, prevLatLng) {
            var speed = latLng.distanceTo(prevLatLng); // meters
            speed /= (latLng.time - prevLatLng.time) / 1000; // m/s
            speed *= 3.6; // km/h
            return speed;
        }

        //Gets upper average speed
        function getSpeedMax(allRoutes) {
            // get the average upper 1/16 of all speeds
            var speeds = [];
            for (var i = 0; i < allRoutes.length; i++) {
                var points = allRoutes[i];
                for (var j = 0; j < points.length - 1; j++) {
                    var speed = getSpeed(points[j+1], points[j]);
                    speeds.push(speed);
                }
            }

            // sort the speeds ascending
            speeds.sort(function(a, b) {
                return a - b;
            });

            // get average
            var sum = 0;
            var count = 0;
            for (var i = Math.floor(speeds.length * 0.94); i < speeds.length; i++) {
                sum += speeds[i];
                count++;
            }

            return Math.round(sum / count);
        }

        //Gets max elapsed time
        function getElapsedMax(allRoutes) {
            var times = [];

            for(var i = 0; i < allRoutes.length; i++) {
                var points = allRoutes[i];

                var time = points[points.length - 1].time - points[0].time;
                time /= 1000; // ms to s

                times.push(time);
            }

            // sort the times ascending
            times.sort(function(a, b) {
                return a - b;
            });

            //return median of upper 1/6 (1-(0,16 / 2))
            return Math.round(times[Math.floor(times.length * 0.94)]);
        }

        //Gets euqal distribution
        function equalDistribution(start, end, midpoints) {
            if (midpoints <= 0) {
                return [];
            }

            const range = end - start;
            const interval = range / (midpoints + 1);

            const result = [];
            for (let i = 1; i <= midpoints; i++) {
                result.push(start + i * interval);
            }

            return result;
        }

        // create map
        var polylines = [];

        var map = L.map('map').setView([50.161, 7.749], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
          maxZoom: 18,
        }).addTo(map);

        //create sidebar
        var sidebar = L.control.sidebar({
            autopan: false,
            closeButton: true,
            container: 'sidebar',
            position: 'left',
        }).addTo(map);

        //query the tours data
        var tours = {};

        var request = new XMLHttpRequest();
        request.open('GET', './tours_data', false);
        request.send(null);
        
        if (request.status === 200) {
            tours = JSON.parse(request.responseText);
        } else {
            console.log('Error: ' + request.status);
            window.location.replace("./login");
        }

        //convert gpx files to leaflet latlngs
        var allRoutes = [];

        for (var i = 0; i < tours.length; i++) {
            var parser = new gpxParser();
            parser.parse(tours[i]);

            var points = parser.tracks[0].points;
            var gpx_latlngs = [];

            for (var j = 0; j < points.length; j++) {
                var latlng = new L.latLng(points[j].lat, points[j].lon, points[j].ele);
                latlng.time = points[j].time
                gpx_latlngs.push(latlng);
            }

            allRoutes.push(gpx_latlngs);
        }

        var speedMax = getSpeedMax(allRoutes);
        var elapsedMax = getElapsedMax(allRoutes);

        Visualizer.show_polylines(map, allRoutes, "heatmap");

      </script>
      
</body>
</html>